
> enhanced-ado-mcp-server@2.1.0 pretest
> npm run generate-openapi


> enhanced-ado-mcp-server@2.1.0 generate-openapi
> tsx scripts/generate-openapi.ts

â‰¡Æ’ÃœÃ‡ Generating OpenAPI specification...

â‰¡Æ’Ã´Ã¼ Creating output directory: C:\Users\ameliapayne\ADO-Work-Item-MSP\docs\api
â‰¡Æ’Ã´Â¥ Generating OpenAPI 3.0 specification...
Î“Â£Ã´ Generated OpenAPI spec: C:\Users\ameliapayne\ADO-Work-Item-MSP\docs\api\openapi.json

â‰¡Æ’Ã´Âª Generating individual JSON schemas...
Î“Â£Ã´ Generated schema: create-workitem.json
Î“Â£Ã´ Generated schema: assign-copilot.json
Î“Â£Ã´ Generated schema: get-context.json
Î“Â£Ã´ Generated schema: extract-security-links.json
Î“Â£Ã´ Generated schema: query-wiql.json
Î“Â£Ã´ Generated schema: query-odata.json
Î“Â£Ã´ Generated schema: execute-bulk-operations.json
Î“Â£Ã´ Generated schema: link-workitems.json
Î“Â£Ã´ Generated schema: undo-bulk.json
Î“Â£Ã´ Generated schema: undo-forensic.json
Î“Â£Ã´ Generated schema: export-work-items.json
Î“Â£Ã´ Generated schema: analyze-workload.json
Î“Â£Ã´ Generated schema: discover-tools.json
Î“Â£Ã´ Generated schema: analyze-query-handle.json
Î“Â£Ã´ Generated schema: analyze-bulk.json
Î“Â£Ã´ Generated schema: list-handles.json
Î“Â£Ã´ Generated schema: inspect-handle.json
Î“Â£Ã´ Generated schema: get-context-bulk.json
Î“Â£Ã´ Generated schema: get-config.json
Î“Â£Ã´ Generated schema: get-team-members.json
Î“Â£Ã´ Generated schema: get-prompts.json
Î“Â£Ã´ Generated schema: list-agents.json
Î“Â£Ã´ Generated schema: discover-custom-fields.json
Î“Â£Ã´ Generated schema: export-field-schema.json
Î“Â£Ã´ Generated schema: get-pr-diff.json
Î“Â£Ã´ Generated schema: get-pr-comments.json
Î“Â£Ã´ Generated schema: add-pr-comment.json
Î“Â£Ã´ Generated schema index: index.json (27 schemas)

Î“Â£Ã  OpenAPI generation complete!

Generated files:
  - docs/api/openapi.json (27 endpoints)
  - docs/api/schemas/*.json (27 schemas)

Output directory: C:\Users\ameliapayne\ADO-Work-Item-MSP\docs\api

You can now use these files to:
  - Generate API clients
  - Create API documentation
  - Validate requests/responses
  - Import into tools like Swagger UI, Postman, etc.

> enhanced-ado-mcp-server@2.1.0 test
> jest odata-query.handler.test.ts --verbose

  console.error
    [2025-12-08T20:35:13.693Z] [INFO] Creating Azure CLI token provider for Analytics API

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.info (src/utils/logger.ts:127:15)
      at getAnalyticsTokenProvider (src/services/handlers/query/odata-query.handler.ts:69:12)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:279:25)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:20)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:258:29)

  console.error
    [2025-12-08T20:35:13.786Z] [INFO] Query handle created: undefined (2 work items)

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.info (src/utils/logger.ts:127:15)
      at executeODataQueryForHandle (src/services/handlers/query/odata-query.handler.ts:517:10)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:223:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:591:22)

  console.error
    [2025-12-08T20:35:13.817Z] [WARN] OData query returned 0 results - cannot create query handle

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.warn (src/utils/logger.ts:146:15)
      at executeODataQueryForHandle (src/services/handlers/query/odata-query.handler.ts:469:12)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:223:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:642:22)

  console.error
    [2025-12-08T20:35:13.822Z] [INFO] Query handle created: undefined (1 work items)

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.info (src/utils/logger.ts:127:15)
      at executeODataQueryForHandle (src/services/handlers/query/odata-query.handler.ts:517:10)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:223:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:675:22)

  console.error
    [2025-12-08T20:35:13.842Z] [ERROR] OData query handler error: {"message":"Cannot read properties of undefined (reading 'ok')","name":"TypeError","stack":"TypeError: Cannot read properties of undefined (reading 'ok')\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:291:19)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:781:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:781:22)

  console.error
    [2025-12-08T20:35:13.850Z] [ERROR] OData Analytics query failed: 401 Unauthorized - TF400813: Resource not available for anonymous access

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:293:14)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:14)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:834:22)

  console.error
    [2025-12-08T20:35:13.853Z] [ERROR] OData query handler error: {"message":"Analytics API authorization error: 401 Unauthorized\n\nThe user account does not have permission to access Azure DevOps Analytics.\n\nREQUIRED PERMISSION: \"View analytics\" at the project level\nThis permission is required to use OData queries for aggregations and analytics.\n\nHOW TO CHECK YOUR PERMISSIONS:\n1. Go to: https://dev.azure.com/test-org/test-project/_settings/security\n2. Search for your email address in the Members list\n3. Look for \"View analytics\" permission in your permissions list\n\nHOW TO FIX:\n1. If you don't have \"View analytics\" permission, contact your Azure DevOps administrator\n2. Alternative: Use WIQL queries (query-wiql tool) which don't require Analytics permissions\n\nMORE INFO: https://learn.microsoft.com/en-us/azure/devops/report/powerbi/analytics-security\n\nTechnical details: TF400813: Resource not available for anonymous access","name":"Error","stack":"Error: Analytics API authorization error: 401 Unauthorized\n\nThe user account does not have permission to access Azure DevOps Analytics.\n\nREQUIRED PERMISSION: \"View analytics\" at the project level\nThis permission is required to use OData queries for aggregations and analytics.\n\nHOW TO CHECK YOUR PERMISSIONS:\n1. Go to: https://dev.azure.com/test-org/test-project/_settings/security\n2. Search for your email address in the Members list\n3. Look for \"View analytics\" permission in your permissions list\n\nHOW TO FIX:\n1. If you don't have \"View analytics\" permission, contact your Azure DevOps administrator\n2. Alternative: Use WIQL queries (query-wiql tool) which don't require Analytics permissions\n\nMORE INFO: https://learn.microsoft.com/en-us/azure/devops/report/powerbi/analytics-security\n\nTechnical details: TF400813: Resource not available for anonymous access\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:296:15)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:834:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:834:22)

  console.error
    [2025-12-08T20:35:13.856Z] [ERROR] OData Analytics query failed: 403 Forbidden - Access denied

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:293:14)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:14)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:850:22)

  console.error
    [2025-12-08T20:35:13.859Z] [ERROR] OData query handler error: {"message":"Analytics API authorization error: 403 Forbidden\n\nThe user account does not have permission to access Azure DevOps Analytics.\n\nREQUIRED PERMISSION: \"View analytics\" at the project level\nThis permission is required to use OData queries for aggregations and analytics.\n\nHOW TO CHECK YOUR PERMISSIONS:\n1. Go to: https://dev.azure.com/test-org/test-project/_settings/security\n2. Search for your email address in the Members list\n3. Look for \"View analytics\" permission in your permissions list\n\nHOW TO FIX:\n1. If you don't have \"View analytics\" permission, contact your Azure DevOps administrator\n2. Alternative: Use WIQL queries (query-wiql tool) which don't require Analytics permissions\n\nMORE INFO: https://learn.microsoft.com/en-us/azure/devops/report/powerbi/analytics-security\n\nTechnical details: Access denied","name":"Error","stack":"Error: Analytics API authorization error: 403 Forbidden\n\nThe user account does not have permission to access Azure DevOps Analytics.\n\nREQUIRED PERMISSION: \"View analytics\" at the project level\nThis permission is required to use OData queries for aggregations and analytics.\n\nHOW TO CHECK YOUR PERMISSIONS:\n1. Go to: https://dev.azure.com/test-org/test-project/_settings/security\n2. Search for your email address in the Members list\n3. Look for \"View analytics\" permission in your permissions list\n\nHOW TO FIX:\n1. If you don't have \"View analytics\" permission, contact your Azure DevOps administrator\n2. Alternative: Use WIQL queries (query-wiql tool) which don't require Analytics permissions\n\nMORE INFO: https://learn.microsoft.com/en-us/azure/devops/report/powerbi/analytics-security\n\nTechnical details: Access denied\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:296:15)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:850:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:850:22)

  console.error
    [2025-12-08T20:35:13.862Z] [ERROR] OData Analytics query failed: 404 Not Found - Project not found

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:293:14)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:14)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:866:22)

  console.error
    [2025-12-08T20:35:13.866Z] [ERROR] OData query handler error: {"message":"Analytics API error: 404 Not Found - Project not found","name":"Error","stack":"Error: Analytics API error: 404 Not Found - Project not found\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:313:13)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:866:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:866:22)

  console.error
    [2025-12-08T20:35:13.876Z] [ERROR] OData query handler error: {"message":"Network error","name":"Error","stack":"Error: Network error\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:876:9)\n    at Promise.then.completed (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\utils.js:298:28)\n    at new Promise (<anonymous>)\n    at callAsyncCircusFn (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\utils.js:231:10)\n    at _callCircusTest (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:316:40)\n    at _runTest (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:252:3)\n    at _runTestsForDescribeBlock (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:126:9)\n    at _runTestsForDescribeBlock (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at _runTestsForDescribeBlock (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:121:9)\n    at run (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\run.js:71:3)\n    at runAndTransformResultsToJestFormat (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapterInit.js:122:21)\n    at jestAdapter (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-circus\\build\\legacy-code-todo-rewrite\\jestAdapter.js:79:19)\n    at runTestInternal (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-runner\\build\\runTest.js:367:16)\n    at runTest (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\node_modules\\jest-runner\\build\\runTest.js:444:34)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:879:22)

  console.error
    [2025-12-08T20:35:13.881Z] [ERROR] OData query handler error: {"message":"Invalid JSON","name":"Error","stack":"Error: Invalid JSON\n    at Object.json (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:905:17)\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:316:27)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:909:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:909:22)

  console.error
    [2025-12-08T20:35:13.888Z] [ERROR] OData Analytics query failed: 400 Bad Request - Invalid OData syntax

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:293:14)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:14)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1107:22)

  console.error
    [2025-12-08T20:35:13.890Z] [ERROR] OData query handler error: {"message":"Analytics API error: 400 Bad Request - Invalid OData syntax","name":"Error","stack":"Error: Analytics API error: 400 Bad Request - Invalid OData syntax\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:313:13)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:1107:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1107:22)

  console.error
    [2025-12-08T20:35:13.894Z] [ERROR] OData Analytics query failed: 400 undefined - Syntax error

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at executeODataAnalytics (src/services/handlers/query/odata-query.handler.ts:293:14)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:219:14)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1131:22)

  console.error
    [2025-12-08T20:35:13.897Z] [ERROR] OData query handler error: {"message":"Analytics API error: 400 undefined - Syntax error","name":"Error","stack":"Error: Analytics API error: 400 undefined - Syntax error\n    at executeODataAnalytics (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:313:13)\n    at handleODataQuery (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\src\\services\\handlers\\query\\odata-query.handler.ts:219:14)\n    at Object.<anonymous> (C:\\Users\\ameliapayne\\ADO-Work-Item-MSP\\mcp_server\\test\\unit\\handlers\\odata-query.handler.test.ts:1131:22)"}

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.error (src/utils/logger.ts:166:15)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:230:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1131:22)

  console.error
    [2025-12-08T20:35:13.906Z] [INFO] Query handle created: undefined (1 work items)

    [0m [90m 27 |[39m       [36mreturn[39m[33m;[39m
     [90m 28 |[39m     }
    [31m[1m>[22m[39m[90m 29 |[39m     originalConsoleError([33m...[39margs)[33m;[39m
     [90m    |[39m     [31m[1m^[22m[39m
     [90m 30 |[39m   })[33m;[39m
     [90m 31 |[39m   
     [90m 32 |[39m   console[33m.[39mwarn [33m=[39m jest[33m.[39mfn(([33m...[39margs) [33m=>[39m {[0m

      at console.<anonymous> (test/setup.ts:29:5)
      at Logger.info (src/utils/logger.ts:127:15)
      at executeODataQueryForHandle (src/services/handlers/query/odata-query.handler.ts:517:10)
      at handleODataQuery (src/services/handlers/query/odata-query.handler.ts:223:12)
      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1291:22)

  console.error
    [2025-12-08T20:35:13.920Z] [INFO] [Telemetry] Shutdown complete

    [0m [90m 125 |[39m     [36mif[39m ([33m![39m[36mthis[39m[33m.[39mmcpConnected) {
     [90m 126 |[39m       [36mconst[39m contextStr [33m=[39m context [33m?[39m [32m` ${JSON.stringify(context)}`[39m [33m:[39m [32m''[39m[33m;[39m
    [31m[1m>[22m[39m[90m 127 |[39m       console[33m.[39merror([32m`[${timestamp}] [INFO] ${message}${contextStr}`[39m)[33m;[39m
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 128 |[39m     }
     [90m 129 |[39m     
     [90m 130 |[39m     [90m// Always write to file if configured[39m[0m

      at Logger.info (src/utils/logger.ts:127:15)
      at TelemetryService.shutdown (src/services/telemetry-service.ts:639:12)
      at Object.<anonymous> (test/setup.ts:64:28)

FAIL test/unit/handlers/odata-query.handler.test.ts
  OData Query Handler
    Azure CLI Validation
      Î“ÃªÃœ should fail when Azure CLI is not available (6 ms)
      Î“ÃªÃœ should fail when not logged into Azure CLI (1 ms)
    Input Validation
      Î“ÃªÃœ should reject invalid input schema (2 ms)
      Î“ÃªÃœ should require description, queryType, or customODataQuery (1 ms)
      Î“ÃªÃœ should validate organization and project are provided (2 ms)
    Area Path Filtering
      Î“ÃªÃœ should properly escape area paths with backslashes (59 ms)
      Î“ÃªÃœ should properly escape area paths with single quotes (1 ms)
      Î“ÃªÃœ should use default area path when not provided (1 ms)
      Î“ÃªÃœ should handle deeply nested area paths (2 ms)
    Query Type Execution
      Î“ÃªÃœ should execute workItemCount query (1 ms)
      Î“ÃªÃœ should execute groupByState query (2 ms)
      Î“ÃªÃœ should execute groupByType query (1 ms)
      Î“ÃªÃœ should execute groupByAssignee query (1 ms)
      Î“ÃªÃœ should execute velocityMetrics query (1 ms)
      Î“ÃªÃœ should execute customODataQuery (1 ms)
    Filter Construction
      Î“ÃªÃœ should apply date range filters (1 ms)
      Î“ÃªÃœ should apply custom filters (18 ms)
      Î“ÃªÃœ should apply iteration path filter
    Query Handle Lifecycle
      â”œÃ¹ should create query handle for non-aggregation queries (6 ms)
      Î“ÃªÃœ should not create query handle for aggregation queries (1 ms)
      Î“ÃªÃœ should handle empty query results gracefully (5 ms)
      â”œÃ¹ should include work item context in query handle (4 ms)
    Pagination
      Î“ÃªÃœ should handle pagination parameters (1 ms)
      Î“ÃªÃœ should include pagination warning when more results available (1 ms)
      Î“ÃªÃœ should not include pagination for single-page results (1 ms)
    Cache Behavior
      â”œÃ¹ should use cached results when available (17 ms)
      â”œÃ¹ should cache results after fetch (3 ms)
    Error Handling
      Î“ÃªÃœ should handle 401 unauthorized errors (6 ms)
      Î“ÃªÃœ should handle 403 forbidden errors (6 ms)
      Î“ÃªÃœ should handle 404 not found errors (6 ms)
      Î“ÃªÃœ should handle network errors (10 ms)
      Î“ÃªÃœ should handle invalid JSON responses (3 ms)
    AI-Powered Query Generation
      Î“ÃªÃœ should fail AI generation without server instance (1 ms)
      Î“ÃªÃœ should fail AI generation when sampling not available
      â”œÃ¹ should generate and execute AI-powered query (1 ms)
      Î“ÃªÃœ should handle AI generation failures gracefully (1 ms)
      â”œÃ¹ should retry failed AI generations
    Metadata Options
      Î“ÃªÃœ should include OData metadata when requested
      â”œÃ¹ should strip OData metadata by default (6 ms)
      â”œÃ¹ should include query metadata when requested (6 ms)
    Edge Cases
      Î“ÃªÃœ should handle empty result sets (1 ms)
      Î“ÃªÃœ should handle null values in results (1 ms)
      â”œÃ¹ should handle very large result sets (2 ms)
      â”œÃ¹ should handle aggregation query with zero results (1 ms)
      Î“ÃªÃœ should handle special characters in filter values (1 ms)
      â”œÃ¹ should handle undefined fields in work item context (3 ms)
    Query Building
      Î“ÃªÃœ should build query with multiple filters (2 ms)
      Î“ÃªÃœ should apply custom groupBy and orderBy (1 ms)
      Î“ÃªÃœ should apply select fields (1 ms)
      Î“ÃªÃœ should URL encode organization and project names with special characters

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Query Handle Lifecycle Î“Ã‡â•‘ should create query handle for non-aggregation queries

    expect(received).toBe(expected) // Object.is equality

    Expected: "qh_odata_abc123"
    Received: undefined

      598 |       expect(result.data).toBeDefined();
      599 |       const data = result.data as any;
    > 600 |       expect(data.query_handle).toBe('qh_odata_abc123');
          |                                 ^
      601 |       expect(data.work_item_count).toBe(2);
      602 |       expect(mockQueryHandleService.storeQuery).toHaveBeenCalledWith(
      603 |         [101, 102],

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:600:33)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Query Handle Lifecycle Î“Ã‡â•‘ should include work item context in query handle

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      680 |
      681 |       expect(result.success).toBe(true);
    > 682 |       expect(mockQueryHandleService.storeQuery).toHaveBeenCalled();
          |                                                 ^
      683 |       
      684 |       const storeCall = mockQueryHandleService.storeQuery.mock.calls[0];
      685 |       const contextMap = storeCall[4] as Map<number, any>;

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:682:49)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Cache Behavior Î“Ã‡â•‘ should use cached results when available

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      783 |       });
      784 |
    > 785 |       expect(result.success).toBe(true);
          |                              ^
      786 |       expect(result.data).toBeDefined();
      787 |       const data = result.data as any;
      788 |       expect(data.results).toBeDefined();

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:785:30)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Cache Behavior Î“Ã‡â•‘ should cache results after fetch

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: Any<String>, {"@odata.context": "test", "value": [{"Count": 10}]}, 300000

    Number of calls: 0

      809 |
      810 |       expect(result.success).toBe(true);
    > 811 |       expect(mockCacheService.set).toHaveBeenCalledWith(
          |                                    ^
      812 |         expect.any(String),
      813 |         mockResponse,
      814 |         5 * 60 * 1000 // 5 minutes

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:811:36)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ AI-Powered Query Generation Î“Ã‡â•‘ should generate and execute AI-powered query

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      988 |       }, mockServerInstance);
      989 |
    > 990 |       expect(result.success).toBe(true);
          |                              ^
      991 |       expect(result.data).toBeDefined();
      992 |       expect(mockSamplingClient.createMessage).toHaveBeenCalled();
      993 |       expect(result.metadata?.aiGenerated).toBe(true);

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:990:30)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ AI-Powered Query Generation Î“Ã‡â•‘ should retry failed AI generations

    expect(jest.fn()).toHaveBeenCalled()

    Expected number of calls: >= 1
    Received number of calls:    0

      1058 |
      1059 |       // Should have made at least one attempt
    > 1060 |       expect(mockSamplingClient.createMessage).toHaveBeenCalled();
           |                                                ^
      1061 |     });
      1062 |   });
      1063 |

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1060:48)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Metadata Options Î“Ã‡â•‘ should strip OData metadata by default

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      1110 |       });
      1111 |
    > 1112 |       expect(result.success).toBe(true);
           |                              ^
      1113 |       expect(result.data).toBeDefined();
      1114 |       const data = result.data as any;
      1115 |       // Metadata should be stripped from results

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1112:30)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Metadata Options Î“Ã‡â•‘ should include query metadata when requested

    expect(received).toBe(expected) // Object.is equality

    Expected: true
    Received: false

      1134 |       });
      1135 |
    > 1136 |       expect(result.success).toBe(true);
           |                              ^
      1137 |       expect(result.data).toBeDefined();
      1138 |       const data = result.data as any;
      1139 |       // includeMetadata affects result.metadata, not result.data

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1136:30)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Edge Cases Î“Ã‡â•‘ should handle very large result sets

    expect(received).toHaveLength(expected)

    Expected length: 1000
    Received length: 1
    Received array:  [{"Count": 10}]

      1220 |       expect(result.data).toBeDefined();
      1221 |       const data = result.data as any;
    > 1222 |       expect(data.results).toHaveLength(1000);
           |                            ^
      1223 |     });
      1224 |
      1225 |     it('should handle aggregation query with zero results', async () => {

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1222:28)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Edge Cases Î“Ã‡â•‘ should handle aggregation query with zero results

    expect(received).toHaveLength(expected)

    Expected length: 0
    Received length: 1
    Received array:  [{"Count": 5}]

      1242 |       const data = result.data as any;
      1243 |       // Empty result set should have count of 0
    > 1244 |       expect(data.results).toHaveLength(0);
           |                            ^
      1245 |       expect(data.count).toBe(0);
      1246 |     });
      1247 |

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1244:28)

  Î“Ã¹Ã… OData Query Handler Î“Ã‡â•‘ Edge Cases Î“Ã‡â•‘ should handle undefined fields in work item context

    expect(received).toBe(expected) // Object.is equality

    Expected: "qh_partial"
    Received: undefined

      1298 |       expect(result.data).toBeDefined();
      1299 |       const data = result.data as any;
    > 1300 |       expect(data.query_handle).toBe('qh_partial');
           |                                 ^
      1301 |     });
      1302 |   });
      1303 |

      at Object.<anonymous> (test/unit/handlers/odata-query.handler.test.ts:1300:33)

Test Suites: 1 failed, 1 total
Tests:       11 failed, 39 passed, 50 total
Snapshots:   0 total
Time:        3.955 s, estimated 6 s
Ran all test suites matching /odata-query.handler.test.ts/i.
Force exiting Jest: Have you considered using `--detectOpenHandles` to detect async operations that kept running after all tests finished?
